name: Generate Configuraion File

# Controls when the workflow will run
on:
  schedule:
    - cron: '0 23 * * *'
  push:
    branches:
      - master
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build_cfg:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      GDOT_IPV4: tls://8.8.4.4
      GDOT_IPV6: tls://2001:4860:4860::8888
      GDOH_IPV4: https://8.8.8.8/dns-query
      GDOH_IPV6: https://[2001:4860:4860::8888]/dns-query
      CDOT_IPV4: tls://1.0.0.1
      CDOH_IPV4: https://1.1.1.1/dns-query
      CDOT_IPV6: tls://2606:4700:4700::1001
      CDOH_IPV6: https://[2606:4700:4700::1001]/dns-query
      ADOT_IPV4: tls://223.5.5.5
      ADNS_IPV4: 223.5.5.5

      ADGUARD_DNS_REJECT_URL:   https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
      # DANPOLLOCK_REJECT_URL:   https://someonewhocares.org/hosts/hosts
      # RAW_LIST_BLOCK_LIST_URL:      https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt
      # PETERLOWE_REJECT_URL:    https://pgl.yoyo.org/adservers/serverlist.php?hostformat=hosts&showintro=1&mimetype=plaintext

      RAW_LIST_PRIVATE_URL:     https://raw.githubusercontent.com/Loyalsoldier/domain-list-custom/release/private.txt
      RAW_LIST_DIRECT_URL:      https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt
      RAW_LIST_ICLOUD_URL:      https://raw.githubusercontent.com/Loyalsoldier/domain-list-custom/release/icloud.txt

      RAW_LIST_PROXY_URL:       https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/gfw.txt

      RAW_RULESET_ORACLE_URL:      https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Oracle/Oracle.list
      RAW_RULESET_OPENAI_URL:      https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.list
      RAW_RULESET_REDDIT_URL:      https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Reddit/Reddit.list
      RAW_RULESET_PAYPAL_URL:      https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PayPal/PayPal.list
      RAW_RULESET_GOOGLE_URL:      https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google.list
      RAW_RULESET_GEMINI_URL:      https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Gemini/Gemini.list
      RAW_RULESET_YOUTUBE_URL:     https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.list
      RAW_RULESET_COPILOT_URL:     https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Copilot/Copilot.list
      RAW_RULESET_MICROSOFT_URL:   https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Microsoft/Microsoft.list
      RAW_RULESET_CLOUDFLARE_URL:  https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Cloudflare/Cloudflare.list

    steps:
      - name: Checkout the "master" branch of this repo
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "RELEASE_NAME=Updated on $(date +%Y%m%d%H%M)" >> $GITHUB_ENV
          echo "TAG_NAME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV

      - name: Download Files
        run: |
          mkdir .tmp
          # Download ruleset files
          wget ${{ env.RAW_RULESET_ORACLE_URL }} -O ./.tmp/oracle_ruleset.txt
          wget ${{ env.RAW_RULESET_OPENAI_URL }} -O ./.tmp/openai_ruleset.txt
          wget ${{ env.RAW_RULESET_REDDIT_URL }} -O ./.tmp/reddit_ruleset.txt
          wget ${{ env.RAW_RULESET_PAYPAL_URL }} -O ./.tmp/paypal_ruleset.txt
          wget ${{ env.RAW_RULESET_GOOGLE_URL }} -O ./.tmp/google_ruleset.txt
          wget ${{ env.RAW_RULESET_GEMINI_URL }} -O ./.tmp/gemini_ruleset.txt
          wget ${{ env.RAW_RULESET_YOUTUBE_URL }} -O ./.tmp/youtube_ruleset.txt
          wget ${{ env.RAW_RULESET_COPILOT_URL }} -O ./.tmp/copilot_ruleset.txt
          wget ${{ env.RAW_RULESET_MICROSOFT_URL }} -O ./.tmp/microsoft_ruleset.txt
          wget ${{ env.RAW_RULESET_CLOUDFLARE_URL }} -O ./.tmp/cloudflare_ruleset.txt
          # Download raw files
          wget ${{ env.RAW_LIST_PROXY_URL }} -O ./.tmp/proxy_list.txt
          wget ${{ env.RAW_LIST_DIRECT_URL }} -O ./.tmp/direct_ruleset.txt
          wget ${{ env.RAW_LIST_ICLOUD_URL }} -O ./.tmp/icloud_list.txt
          wget ${{ env.RAW_LIST_PRIVATE_URL }} -O ./.tmp/private_list.txt
          wget ${{ env.ADGUARD_DNS_REJECT_URL }} -O ./.tmp/adguard_dns_list.txt

      - name: Pre-process Files
        run: |
          cat ./.tmp/adguard_dns_list.txt | perl -ne '/^\|\|([-_0-9a-zA-Z]+(\.[-_0-9a-zA-Z]+){1,64})\^$/ && print "$1\n"' | perl -ne 'print if not /^[0-9]{1,3}(\.[0-9]{1,3}){3}$/' | \
              tee ./.tmp/block_list.txt > /dev/null
          python3 script/list2ruleset.py ./.tmp/block_list.txt -o ./.tmp/block_.txt
          python3 script/list2ruleset.py ./.tmp/proxy_list.txt -o ./.tmp/proxy_ruleset.txt
          python3 script/list2ruleset.py ./.tmp/direct_ruleset.txt -o ./.tmp/direct_ruleset.txt
          python3 script/list2ruleset.py ./.tmp/icloud_list.txt -o ./.tmp/icloud_ruleset.txt
          python3 script/list2ruleset.py ./.tmp/private_list.txt -o ./.tmp/private_ruleset.txt
          cat ./.tmp/icloud_ruleset.txt ./.tmp/private_ruleset.txt >> ./.tmp/direct_ruleset.txt

      - name: Process Warp Rules
        run: |
          cat ./.tmp/oracle_ruleset.txt ./.tmp/openai_ruleset.txt ./.tmp/reddit_ruleset.txt ./.tmp/paypal_ruleset.txt ./.tmp/google_ruleset.txt \
              ./.tmp/gemini_ruleset.txt ./.tmp/youtube_ruleset.txt ./.tmp/copilot_ruleset.txt ./.tmp/microsoft_ruleset.txt ./.tmp/cloudflare_ruleset.txt \
              > ./.tmp/warp_ruleset.txt
          python3 script/customize_ruleset.py ./.tmp/warp_ruleset.txt ./configuration/customized_list/warp.txt
          python3 script/sortlist.py ./.tmp/warp_ruleset.txt
          cat ./.tmp/warp_ruleset.txt | tee ./configuration/release/sgmodule/rule/proxy_warp.sgmodule
                                            ./configuration/release/ruleset/txt/warp.txt
                                            > /dev/null
          python3 script/gen_sr_mod.py ./configuration/release/sgmodule/rule/proxy_warp.sgmodule RULE PROXY-WARP force-remote-dns


      - name: Process Direct Rules
        run: |
          python3 script/format_list.py ./.tmp/direct_ruleset.txt
          python3 script/customize_ruleset.py ./.tmp/direct_ruleset.txt ./configuration/customized_list/direct.txt
          python3 script/sortlist.py ./.tmp/direct_ruleset.txt
          cat ./.tmp/warp_ruleset.txt | tee ./configuration/release/sgmodule/rule/direct.sgmodule
                                            ./configuration/release/ruleset/txt/direct.txt
                                            > /dev/null
          python3 script/gen_sr_mod.py ./configuration/release/sgmodule/rule/direct.sgmodule RULE DIRECT


      - name: Process Proxy Rules
        run: |
          python3 script/format_list.py ./.tmp/proxy_list.txt
          python3 script/customize_ruleset.py -m remove_domains ./.tmp/proxy_list.txt ./.tmp/warp_ruleset.txt
          python3 script/customize_ruleset.py -m remove_domains ./.tmp/proxy_list.txt ./.tmp/direct_ruleset.txt
          python3 script/customize_ruleset.py ./.tmp/proxy_list.txt ./configuration/customized_list/proxy.txt
          python3 script/sortlist.py ./.tmp/proxy_list.txt
          cat ./.tmp/proxy_list.txt | tee ./configuration/release/sgmodule/rule/proxy_remote_dns.sgmodule
                                          ./configuration/release/ruleset/txt/proxy.txt
                                          > /dev/null

      - name: Process Block Rules
        run: |
          python3 script/format_list.py ./.tmp/block_list.txt
          python3 script/customize_ruleset.py ./.tmp/block_list.txt ./configuration/customized_list/block_default.txt
          python3 script/customize_ruleset.py ./configuration/release/sgmodule/rule/block_reject_dict.sgmodule ./configuration/customized_list/block_reject_dict.txt
          python3 script/customize_ruleset.py ./configuration/release/sgmodule/rule/block_reject_array.sgmodule ./configuration/customized_list/block_reject_array.txt
          cat ./.tmp/block_list.txt | tee ./configuration/release/sgmodule/rule/block_reject.sgmodule \
                                          ./configuration/release/sgmodule/rule/block_reject_drop.sgmodule \
                                          ./configuration/release/ruleset/txt/block.txt
                                          > /dev/null
          python3 script/gen_sr_mod.py ./configuration/release/sgmodule/rule/block_reject.sgmodule RULE REJECT
          python3 script/gen_sr_mod.py ./configuration/release/sgmodule/rule/block_reject_drop.sgmodule RULE REJECT-DROP
          python3 script/gen_sr_mod.py ./configuration/release/sgmodule/rule/block_reject_dict.sgmodule RULE REJECT-DICT
          python3 script/gen_sr_mod.py ./configuration/release/sgmodule/rule/block_reject_array.sgmodule RULE REJECT-ARRAY

      - name: Process Domain-DNS Rules
        run: |
          python3 script/customize_ruleset.py ./configuration/release/sgmodule/host/domain_dns_adot.sgmodule ./configuration/customized_list/domain_dns.txt
          python3 script/customize_ruleset.py ./configuration/release/sgmodule/host/domain_dns_gdot.sgmodule ./configuration/customized_list/domain_dns.txt
          python3 script/gen_sr_mod.py ./configuration/release/sgmodule/host/domain_dns_adot.sgmodule HOST DOMAIN-DNS ${{ env.ADOT_IPV4 }}
          python3 script/gen_sr_mod.py ./configuration/release/sgmodule/host/domain_dns_gdot.sgmodule HOST DOMAIN-DNS ${{ env.GDOT_IPV4 }}

      - name: Generate Modules
        run: |

      - name: Generate Clash RuleSet
        run: |
          python3 script/list2clashRuleset.py ./.tmp/warp_ruleset.txt ./configuration/release/rule-set/warp.yaml
          python3 script/list2clashRuleset.py ./.tmp/proxy_list.txt ./configuration/release/rule-set/proxy.yaml
          python3 script/list2clashRuleset.py ./.tmp/direct_ruleset.txt ./configuration/release/rule-set/direct.yaml
          python3 script/list2clashRuleset.py ./.tmp/block_list_clash.txt ./configuration/release/rule-set/block.yaml

      # - name: Generate main cfg
      #   run: |
      #     python3 script/gen_sr_mod.py ./.tmp/direct_ruleset.txt TEXT RULE DIRECT
      #     cat ./configuration/customized_list/sr_base.conf > ./configuration/release/sr_ark.conf
      #     cat ./.tmp/direct_ruleset.txt >> ./configuration/release/sr_ark.conf
      #     cat ./configuration/customized_list/geoip_rule.txt >> ./configuration/release/sr_ark.conf

      - name: Clean temp directory
        run: rm -rf .tmp
      # - name: Release and upload assets
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     name: ${{ env.RELEASE_NAME }}
      #     tag_name: ${{ env.TAG_NAME }}
      #     draft: false
      #     prerelease: false
      #     files: |
      #       ./configuration/release/sr_ark.conf
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "Updated on $(date +%Y%m%d%H%M)" -a
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
